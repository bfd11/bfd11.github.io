import{c as T,_ as x}from"./BeefyV2AppMulticall-c5605e28.js";import{ab as E,fb as B,bb as I,aC as _,a$ as g}from"./index-40f6b818.js";const v=x;class L{constructor(r,i){this.web3=r,this.chain=i}async fetchAllAllowances(r,i,h,m,u){const d=new this.web3.eth.Contract(v,this.chain.appMulticallContractAddress),a={},A={},c=(s,o)=>{const e=_(r,this.chain.id,s),n=e.address.toLowerCase();if(!g(e))throw new Error(`Can't query allowance of non erc20 token, skipping ${e.id}`);a[n]===void 0&&(a[n]={tokenAddress:e.address,spenders:new Set}),a[n].spenders.add(o),A[n]===void 0&&(A[n]=e)};for(const s of i)c(s.earnedTokenAddress,s.earnContractAddress),c(s.depositTokenAddress,s.earnContractAddress);for(const s of h)c(s.depositTokenAddress,s.earnContractAddress);for(const s of m){const o=E(r,s.vaultId);c(o.earnedTokenAddress,s.earnContractAddress)}const C=B(),p=Object.entries(a),w=T(p,C),y=w.map(s=>d.methods.getAllowancesFlat(s.map(([o,e])=>o),s.map(([o,e])=>Array.from(e.spenders)),u).call()),k=await Promise.all([...y]),f=[];let t=0;for(const s of w){const o=k[t];let e=0;for(const n of s.map(l=>l[1]))for(const l of Array.from(n.spenders)){const b=o[e];b!=="0"&&f.push({tokenAddress:n.tokenAddress,spenderAddress:l,allowance:new I(b).shiftedBy(-A[n.tokenAddress.toLowerCase()].decimals)}),e++}t++}return f}async fetchTokensAllowance(r,i,h,m){const u=new this.web3.eth.Contract(v,this.chain.appMulticallContractAddress),d={},a={},A=(t,s)=>{const o=_(r,this.chain.id,t),e=o.address.toLowerCase();if(!g(o))throw new Error(`Can't query allowance of non erc20 token, skipping ${o.id}`);d[e]===void 0&&(d[e]={tokenAddress:o.address,spenders:new Set}),d[e].spenders.add(s),a[e]===void 0&&(a[e]=o)};for(const t of i)A(t.address,m);const c=B(),C=Object.entries(d),p=T(C,c),w=p.map(t=>u.methods.getAllowancesFlat(t.map(([s,o])=>s),t.map(([s,o])=>Array.from(o.spenders)),h).call()),y=await Promise.all([...w]),k=[];let f=0;for(const t of p){const s=y[f];let o=0;for(const e of t.map(n=>n[1]))for(const n of Array.from(e.spenders)){const l=s[o];l!=="0"&&k.push({tokenAddress:e.tokenAddress,spenderAddress:n,allowance:new I(l).shiftedBy(-a[e.tokenAddress.toLowerCase()].decimals)}),o++}f++}return k}}export{L as AllowanceAPI};
